# AI 对话功能设计文档

> V1 版本 - 基础对话功能

---

## 1. 功能定位

AI 对话是 MindLink 的第四种交互方式：

| 功能 | 作用 | 数据流向 |
|------|------|----------|
| 投喂 | 输入想法 | 用户 → 系统 |
| 时间轴/叙事/结构 | 查看整理结果 | 系统 → 用户 |
| 输出 | 按指令生成内容 | 系统 → 用户 |
| **AI 对话** | 双向讨论、分析、探索 | 用户 ↔ AI |

**核心价值**：和一个"完全了解你这个想法"的 AI 进行开放式讨论，获得新视角和意外惊喜。

---

## 2. 技术架构

### 2.1 数据流

```
用户发送消息
    ↓
获取最新数据（每次都拉取）
  - Crystal 结构（第3层）
  - 时间轴内容（第1层）
    ↓
组装上下文
  - 系统提示词（可配置）
  - Mind 数据
  - 对话历史
    ↓
调用 AI Hub
    ↓
返回 AI 回复
    ↓
更新前端对话列表
```

### 2.2 上下文管理

**解决"数据更新"问题的方案：**

- 对话历史：存储在前端（会话级别）
- Mind 数据：每次发消息时重新获取最新
- 刷新对话：清空对话历史，但保留 Mind 数据

这样既能连续讨论，又能及时获取最新投喂的内容。

### 2.3 提示词管理

**系统提示词结构：**

```
[基础角色定义]
你是一个智能助手，正在帮助用户深入思考「{mind_title}」这个主题。

[当前认知概览]
{crystal_summary}

[时间轴记录]
{timeline_content}

[行为准则]
1. 基于用户的真实想法进行讨论
2. 可以提出新视角，但标注是你的补充
3. 不编造事实，不臆断用户意图
4. 鼓励用户思考，可以反问

[风格设定]（可配置）
{style_prompt}
```

**提示词类型（存入 prompts 表）：**

| prompt_key | 用途 |
|------------|------|
| `chat_base` | 基础角色定义 |
| `chat_style_default` | 默认风格（理性分析） |
| `chat_style_socratic` | 苏格拉底式（多反问） |
| `chat_style_creative` | 创意发散式 |

---

## 3. 模型选择

### 3.1 可用模型

| 显示名称 | adapter_id | 特点 | 建议场景 |
|----------|------------|------|----------|
| Gemini 3 Flash | `google_gemini_3_flash` | 快速、便宜 | 日常对话 |
| Gemini 3 Pro | `google_gemini_3_pro` | 更智能、深度思考 | 深度分析 |
| GPT-5.2 柏拉图 | `plato_gpt_5_2_chat` | OpenAI 最强 | 复杂推理 |

### 3.2 模型参数

- `thinking_level`: Gemini 系列支持 (minimal/low/medium/high)
- `temperature`: 创造性控制 (默认 0.7)
- `max_output_tokens`: 回复长度限制

---

## 4. API 设计

### 4.1 发送消息

```
POST /api/minds/{mind_id}/chat
```

**请求体：**
```json
{
  "message": "用户输入的消息",
  "history": [
    {"role": "user", "content": "之前的消息"},
    {"role": "assistant", "content": "AI的回复"}
  ],
  "model": "google_gemini_3_flash",
  "style": "default"
}
```

**响应：**
```json
{
  "reply": "AI 的回复内容",
  "model_used": "google_gemini_3_flash"
}
```

### 4.2 获取可用模型

```
GET /api/chat/models
```

**响应：**
```json
{
  "models": [
    {"id": "google_gemini_3_flash", "name": "Gemini 3 Flash", "description": "快速响应"},
    {"id": "google_gemini_3_pro", "name": "Gemini 3 Pro", "description": "深度思考"},
    {"id": "plato_gpt_5_2_chat", "name": "GPT-5.2 柏拉图", "description": "最强推理"}
  ]
}
```

### 4.3 获取对话风格

```
GET /api/chat/styles
```

**响应：**
```json
{
  "styles": [
    {"id": "default", "name": "理性分析", "description": "客观、有条理"},
    {"id": "socratic", "name": "苏格拉底式", "description": "多反问，引导思考"},
    {"id": "creative", "name": "创意发散", "description": "联想丰富，开放性强"}
  ]
}
```

---

## 5. 前端设计

### 5.1 UI 布局

新增"对话"标签页，布局：

```
┌─────────────────────────────────────┐
│ [模型选择 ▼]  [风格选择 ▼]  [刷新对话] │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐   │
│  │ 用户: 你好                    │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ AI: 你好！我已经了解了你关于   │   │
│  │ 「xxx」的想法，有什么想讨论的？│   │
│  └─────────────────────────────┘   │
│                                     │
├─────────────────────────────────────┤
│ [输入框...                ] [发送]  │
└─────────────────────────────────────┘
```

### 5.2 交互逻辑

1. 进入对话标签页：显示欢迎语
2. 发送消息：调用 API，显示加载状态
3. 收到回复：追加到对话列表
4. 刷新对话：确认后清空历史
5. 切换模型/风格：下次发送时生效

---

## 6. 数据库设计

### 6.1 提示词表扩展

在现有 `prompts` 表中添加：

| prompt_key | 用途 |
|------------|------|
| `chat_base` | 对话基础提示词 |
| `chat_style_default` | 默认风格 |
| `chat_style_socratic` | 苏格拉底式 |
| `chat_style_creative` | 创意发散式 |

### 6.2 对话历史（V1 不存数据库）

V1 版本对话历史只存前端，刷新页面即清空。

V2 可考虑：
- 存入数据库，支持历史回溯
- 支持"存档"功能，保存有价值的对话

---

## 7. 实现计划

| 步骤 | 内容 |
|------|------|
| 1 | 后端：新增 chat API 路由 |
| 2 | 后端：实现对话服务（上下文组装 + AI调用） |
| 3 | 后端：添加对话提示词到 prompts 表 |
| 4 | 前端：新增"对话"标签页 UI |
| 5 | 前端：实现对话交互逻辑 |
| 6 | 测试：完整对话流程 |

---

## 8. 未来扩展（V2+）

- 对话中录入：AI 识别"新认知"，一键录入
- 对话中管理：标记过时、修正（需确认机制）
- 对话历史存档：保存有价值的讨论
- 多轮深度推理：支持 thinking 模式

---

**文档版本**: v1.0
**创建日期**: 2025-12-28
