# AI 程序员协作规范系统

> 本文档是一套通用方法论，帮助不懂编程的产品经理高效地与 AI 程序员协作。
>
> 本文档不针对特定项目，而是提供一个可复用的框架。

**文档维护声明**：本文档可以修改。如果发现内容与实际不符、过时、或有错误，必须修改。但保持精简，避免臃肿。

---

## 核心认知

### AI 程序员的本质

AI 程序员 = **聪明但没有记忆的临时工**

每次会话都是全新的，AI 不记得：
- 上次改了什么
- 为什么这样设计
- 踩过什么坑

所以，**文档就是 AI 的记忆**。文档质量决定协作效率。

### 不懂程序的人的劣势

1. 看不懂代码对不对
2. 不知道改动会不会破坏其他功能
3. 无法评估 AI 的方案是否合理

### 应对策略

| 劣势 | 应对 |
|------|------|
| 看不懂代码 | 建立可验证的输出机制（测试、构建、检查清单） |
| 不知道影响范围 | 要求 AI 说明改动影响，并在规范中明确边界 |
| 无法评估方案 | 要求 AI 给出多个方案并解释优劣，而不是直接执行 |

---

## 五大原则

```
1. 规范的地基    — 先有规范，再写代码
2. 信息的透明    — AI 需要知道的，文档里都有
3. 文档的更新    — 文档必须和代码同步
4. 自循环优化    — 错误变成教训，教训变成规范
5. 可验证的输出  — 改完能证明是对的
```

---

## 文档体系设计

### 层级结构

```
地基文档（CLAUDE.md）
│   ├── 协作原则（必读）
│   ├── 项目概览（必读）
│   ├── 核心规范（必读）
│   ├── 专题索引（指向子文档）
│   └── 历史教训（精简版）
│
├── 专题文档（按需加载）
│   ├── 前端规范
│   ├── 后端规范
│   ├── 数据库规范
│   ├── 样式规范
│   └── ...
│
└── 错误档案（LESSONS.md）
    └── 历史踩坑记录
```

### 地基文档（CLAUDE.md）设计原则

| 原则 | 说明 |
|------|------|
| **精简** | 控制在 150-200 行，避免上下文浪费 |
| **必读** | 只放每次会话都需要知道的内容 |
| **索引** | 详细内容放子文档，地基文档只做索引 |
| **分级** | 明确标注"必读"和"按需参考" |

### 地基文档推荐结构

```markdown
# 项目名 - Claude Code 开发指南

## 协作原则（必读）
- 角色定位
- 开发铁律
- 禁止行为

## 项目概览（必读）
- 一句话定位
- 技术栈
- 架构图（简化版）

## 核心规范（必读）
- 代码规范要点
- 提交规范
- 关键约束（如：不能改的文件）

## 专题索引（Skill 自动加载）
| 场景 | Skill | 说明 |
|------|-------|------|
| 改前端 | frontend | 语义匹配后自动加载 |
| 改提示词 | prompt | 语义匹配后自动加载 |
| 改数据库 | database | 语义匹配后自动加载 |

## 历史教训（必读）
- 教训1：xxx（日期）
- 教训2：xxx（日期）

## 验证清单
改完后必须确认：
- [ ] 构建通过
- [ ] 核心流程可用
- [ ] 没有引入新警告
```

---

## Skill 机制

### 什么是 Skill

Skill 是 Claude Code 的**自动加载文档机制**：
- Claude 启动时预加载所有 Skill 的 name 和 description（约 100 tokens/skill）
- 当用户请求**语义匹配**某个 Skill 的 description 时，Claude 自动加载完整内容
- **无需用户手动调用**，与 Slash Command（`/xxx`）不同

### Skill 目录结构

```
.claude/skills/
├── frontend/
│   └── SKILL.md
├── prompt/
│   └── SKILL.md
└── database/
    └── SKILL.md
```

### SKILL.md 格式

```yaml
---
name: frontend
description: 前端开发规范。当任务涉及修改 HTML、CSS、JS 或多端一致性检查时自动加载。
---

# 详细指令

## 规范要点
...

## 验证清单
...
```

**关键点**：
- `name`：Skill 标识符
- `description`：Claude 用这个判断何时加载（语义匹配）
- description 要写清楚触发场景

### 适合放 Skill 的内容

- 前端样式规范（只有改 UI 时才需要）
- 数据库操作规范（只有改数据层时才需要）
- API 设计规范（只有加接口时才需要）
- 部署流程（只有部署时才需要）

### Skill vs Slash Command

| 类型 | 目录 | 触发方式 | 适用场景 |
|------|------|----------|----------|
| Skill | `.claude/skills/` | 语义自动匹配 | 专题规范文档 |
| Slash Command | `.claude/commands/` | 用户输入 `/xxx` | 固定流程（如 `/hello`） |

---

## 错误档案机制

### 目的

把历史踩坑变成可复用的教训，避免重复犯错。

### 错误档案结构（LESSONS.md）

```markdown
# 历史教训档案

## 活跃教训（当前仍需注意）

### [2024-01-15] 多端 ID 不一致导致功能失效
**现象**：移动端某功能不工作
**原因**：桌面端改了元素 ID，移动端没同步
**教训**：改前端时必须检查两端 ID 一致性
**状态**：活跃

### [2024-01-10] 提示词硬编码导致后台修改无效
**现象**：后台改了提示词但没生效
**原因**：代码里硬编码了提示词，没走 get_prompt()
**教训**：提示词必须通过 get_prompt() 获取
**状态**：活跃

---

## 已解决（仅供参考）

### [2024-01-05] xxx
**状态**：已通过架构调整根本解决，无需再关注
```

### 错误档案维护规则

1. **新增**：出现新的踩坑，立即记录
2. **分类**：区分"活跃"和"已解决"
3. **清理**：已根本解决的问题，移到"已解决"区域
4. **精简**：每条教训控制在 5 行以内

---

## 自循环优化流程

### 核心逻辑

**重心放在前面做对，而不是后面补救**

我们曾尝试设计独立的"审查 agent"在任务完成后触发，但实践发现：
- 软规则没有强制力，AI 倾向于"完成就结束"
- 独立 agent 触发不可靠

**最终方案**：把文档更新检查融入 git commit 流程（这是自然的、必经的节点）

### 架构图

```
执行任务
    │
    ├── 遇到故障？──是──► debug agent
    │                      ├── 查阅 LESSONS.md
    │                      ├── 返回相关经验
    │                      └── 解决后登记新教训
    │
    ▼
任务完成
    │
    ▼
准备 commit
    │
    ├── 检查文档：有错误/需更新/需新增？
    │      │
    │      ├── 有 → 先修改文档
    │      └── 无 → 继续
    │
    ▼
提交 git
```

### debug agent（错误审查）

**触发条件**：
- 代码执行报错
- 测试失败
- 用户反馈"不对"或"有问题"

**职责**：
1. 查阅 LESSONS.md 寻找相关经验
2. 如果找到 → 返回给主程序参考
3. 如果没找到 → 尝试解决
4. 解决后判断是否值得登记到 LESSONS.md

**登记原则**：
- 只登记可复用的教训
- 不登记一次性 typo
- 每条教训 ≤5 行

### 文档更新检查（融入 git commit）

**时机**：准备 commit 前

**检查内容**：
1. 这次修改过程中，有没有发现文档描述与实际不符？
2. 这次修改是否需要更新相关文档？
3. 是否有必要新增文档内容？

**处理**：
- 有则先修改文档，再 commit
- 没有则直接 commit

### 文档更新原则

**该更新的**：
- 架构/模式发生变化
- 新增了重要规范
- 发现文档描述与实际不符

**不该更新的**：
- 具体业务逻辑细节
- 一次性的修复内容
- 某个功能的实现细节

**删除优先**：发现过时内容，删除比添加更重要

---

## 验证机制

### 为什么需要验证

不懂程序的人最大的风险是：**AI 说改好了，你信了，但其实没改好。**

### 验证层级

| 层级 | 方式 | 说明 |
|------|------|------|
| L1 | 构建通过 | 最基本的检查，代码能跑 |
| L2 | 测试通过 | 自动化测试（如果有） |
| L3 | 手动验证 | 核心流程检查清单 |
| L4 | 代码审查 | AI 自检或人工 review |

### 核心流程检查清单示例

```markdown
## 改动后必须验证

### 后端改动
- [ ] 服务能启动
- [ ] API 能调通（用 curl 或 Postman）
- [ ] 日志没有报错

### 前端改动
- [ ] 页面能打开
- [ ] 核心功能可用（列表、详情、提交）
- [ ] 控制台没有报错

### 数据库改动
- [ ] 迁移脚本能执行
- [ ] 旧数据不丢失
- [ ] 查询性能无明显下降
```

---

## 任务分解原则

### 粒度判断

| 任务大小 | 特征 | 建议 |
|----------|------|------|
| 太大 | 涉及多个模块、需要多轮对话 | 拆分成子任务 |
| 合适 | 一次会话能完成、改动范围清晰 | 直接执行 |
| 太小 | 改一行字、加一个注释 | 可以合并多个小任务 |

### 拆分示例

❌ 太大的任务：
> "给系统加一个用户认证功能"

✅ 拆分后：
1. 设计认证方案（讨论，不写代码）
2. 创建用户表
3. 实现登录接口
4. 实现注册接口
5. 前端加登录页面
6. 接入认证中间件

---

## 协作对话模板

### 任务开始

```
用户：hello

AI：[读取 CLAUDE.md，理解项目，汇报理解，请求任务]
```

### 下达任务

```
用户：我想要 xxx 功能

AI：
1. 确认理解：你是想要 xxx，对吗？
2. 说明方案：我打算这样做 xxx
3. 说明影响：这会改动 xxx 文件
4. 请求确认：可以开始吗？
```

### 任务完成

```
AI：
1. 改动说明：我改了 xxx
2. 验证结果：已确认 xxx 通过
3. 注意事项：后续需要注意 xxx（如果有）
```

### 遇到问题

```
AI：
1. 问题描述：我遇到了 xxx
2. 已尝试：我试过 xxx
3. 需要帮助：请确认 xxx / 请提供 xxx
```

---

## 文档维护规范

### 文档维护声明（推荐）

每个文档开头添加维护声明，形成"双重保险"：

```markdown
**文档维护声明**：本文档可以修改。如果发现内容与实际不符、过时、或有错误，必须修改。但保持精简，避免臃肿。
```

这样做的好处：
1. 明确告诉 AI 这不是"只读"文档
2. 强调"必须修改"而非"可以修改"
3. 同时提醒保持精简

### 更新时机

| 时机 | 动作 |
|------|------|
| 代码结构变化 | 更新 CLAUDE.md 的架构部分 |
| 新增踩坑 | 写入 LESSONS.md |
| 规范变化 | 更新对应的规范文档 |
| 发现文档过时 | 立即修正 |

### 更新原则

| 原则 | 说明 |
|------|------|
| 迭代而非追加 | 修改现有内容，不要只加不删 |
| 精简优先 | 能删就删，能合并就合并 |
| 同步更新 | 改代码时同步改文档 |
| 标注日期 | 重要更新标注日期 |

### 文档健康度检查

定期（每月/每季度）检查：
- [ ] CLAUDE.md 是否仍然准确？
- [ ] LESSONS.md 是否有过时的条目？
- [ ] 专题文档是否和代码同步？

---

## 总结

```
┌─────────────────────────────────────────────────────────┐
│                AI 程序员协作规范系统                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   地基文档（CLAUDE.md）                                  │
│   ├── 精简、必读、索引、分级                             │
│                                                         │
│   专题文档（Skill / 子文档）                             │
│   ├── 按需加载、节省上下文                               │
│                                                         │
│   错误档案（LESSONS.md）                                 │
│   ├── 自循环优化、避免重复踩坑                           │
│                                                         │
│   验证机制                                               │
│   ├── 构建、测试、手动检查、代码审查                     │
│                                                         │
│   文档维护                                               │
│   ├── 迭代更新、精简优先、同步更新                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

**文档版本**: v1.1
**创建日期**: 2026-01-09
**最后更新**: 2026-01-09
**适用对象**: 需要与 AI 程序员协作的产品经理/非技术人员

**更新记录**:
- v1.1: 简化自循环优化流程（删除独立 review agent，融入 git commit）；添加文档维护声明最佳实践
- v1.0: 初始版本
