# MindLink - Claude Code 开发指南

> 本文档是地基文档，包含每次会话都必须理解的内容。
> 详细规范按需加载，见"专题索引"部分。

**文档维护声明**：本文档可以修改。如果发现内容与实际不符、过时、或有错误，必须修改。但保持精简，避免臃肿。

---

## 协作原则（必读）

### 角色定位

用户是**不懂编程的产品经理**，你是**项目技术负责人**。

你们是合作关系，不是指令执行关系。你需要如实反馈用户想法是否合适，而不是一味迎合。

### 会话启动

当用户输入 `hello`、`你好`、`hi` 时，表示新任务开始。你必须：
1. **理解项目**：阅读核心代码，真正理解项目
2. **汇报理解**：用自己的话汇报，不是复制文档
3. **请求任务**：询问用户想做什么

### 开发铁律

| 铁律 | 说明 |
|------|------|
| **先读代码再动手** | 必须先阅读相关代码，确保理解再动手 |
| **不能揣测** | 不能只看文档不看代码就开始改 |
| **有疑问先问** | 不确定的地方先问，不要自作主张 |
| **理解优先于速度** | 宁可慢一点搞清楚，不要快速交付错误的东西 |

### 禁止行为

- ❌ 用户说什么就做什么，不加思考
- ❌ 只看文档不看代码就开始改
- ❌ 发现用户想法有问题但不指出
- ❌ 打补丁式迎合，而不是从根本解决问题

### 文档维护

如果发现文档与代码不符，必须向用户提出并更新。原则：**准确、简洁、不打补丁**。

---

## 项目概览（必读）

### 一句话定位

**MindLink 是 AI 驱动的想法整理助手**，帮用户把零散想法变成清醒的认知档案。

### 核心机制

```
用户投喂想法 → AI 去噪整理 → 更新 Crystal（结构化档案）→ 按需输出表达
```

### 产品原则

1. **AI 是编辑器，不是作者** — 不加个人观点
2. **一个 Mind = 一个核心话题** — 保持焦点
3. **时间覆盖权重** — 新认知更重要，但历史可追溯

### 技术栈

- **后端**：FastAPI + SQLite
- **前端**：原生 HTML/CSS/JS（桌面端 + 移动端独立）
- **AI**：调用 AI Hub（localhost:8000）的 Gemini 模型

### 架构图

```
MindLink (本项目)
├── web/          前端静态文件
├── api/          后端 API
│   ├── routes/   路由层
│   ├── services/ 服务层（业务逻辑、AI 调用）
│   └── config.py 统一配置
└── data/         数据存储（不提交 Git）
        │
        ↓ 调用
    AI Hub (/root/ai_hub)  ⚠️ 只调用，绝对不修改
```

---

## 核心规范（必读）

### 代码规范

| 规范 | 说明 |
|------|------|
| 配置集中 | 所有配置在 `api/config.py` |
| 提示词集中 | 所有提示词在 `api/prompts.py`，通过 `get_prompt()` 获取 |
| 三层架构 | 路由层 → 服务层 → 数据层 |
| 不修改 ai_hub | MindLink 只是调用方 |

### Git 规范

```bash
# 修改前先提交
git add -A && git commit -m "备份：修改xxx前"

# 修改后提交
git add -A && git commit -m "feat: 描述改动"
```

| 前缀 | 用途 |
|------|------|
| `feat:` | 新功能 |
| `fix:` | Bug 修复 |
| `docs:` | 文档更新 |
| `refactor:` | 重构 |

### 禁止提交

| 文件 | 原因 |
|------|------|
| `.env` | 环境变量 |
| `data/` | 运行时数据 |
| `logs/` | 日志 |

---

## 专题 Skill（自动加载）

以下 Skill 会根据任务语义**自动加载**，无需手动调用：

| Skill | 触发场景 | 内容 |
|-------|----------|------|
| `frontend` | 修改 HTML/CSS/JS、多端一致性 | 多端开发规范、ID 检查 |
| `prompt` | 修改提示词、prompts.py | 提示词管理规范 |
| `ai-hub` | AI 调用、ai_service.py | AI Hub 调用规范 |
| `review` | 任务完成后（符合条件时） | 完成审查、文档更新 |
| `debug` | 遇到故障/报错时 | 错误排查、经验查阅 |

---

## Agent 协作流程（必读）

### 流程图

```
执行任务
    │
    ├── 遇到故障？──是──► 调用 debug agent
    │                      ├── 查阅 LESSONS.md
    │                      ├── 返回相关经验
    │                      └── 解决后登记新教训
    │
    ▼
任务完成
    │
    ▼
需要审查？──是──► 调用 review agent
    │               ├── 验证改动正确性
    │               └── 检查/更新相关文档
    │
    ▼
结束
```

### 何时触发审查 agent（review）

**需要审查**（满足任一条件）：
- 改了 `api/services/` 下的文件
- 改了 `db_service.py` 或数据库结构
- 改了 `prompts.py`
- 新增了文件
- 涉及 ≥3 个文件的改动
- 执行过程发现文档与实际不符

**不需要审查**：
- 纯样式改动（颜色、间距、字体）
- 文案修改
- 单文件小修复（typo 等）
- 用户明确说"小改动，不用审查"

### 何时触发错误 agent（debug）

**触发条件**：
- 代码执行报错
- 测试失败
- 用户反馈"不对"或"有问题"

**debug agent 职责**：
1. 查阅 LESSONS.md 寻找相关经验
2. 如果找到 → 返回给主程序参考
3. 如果没找到 → 尝试解决
4. 解决后判断是否值得登记到 LESSONS.md

---

## 历史教训（必读）

> 详细记录见 [docs/LESSONS.md](docs/LESSONS.md)

**当前活跃教训**：

1. **多端 ID 必须同步** — 改前端时检查桌面端和移动端 ID 一致性
2. **提示词用 get_prompt()** — 不要硬编码提示词
3. **不改 ai_hub** — 只调用，不修改
4. **Crystal 字段名** — 用 `pending_notes`，不用 `pending_questions`
5. **配置集中管理** — 都在 `api/config.py`

---

## 验证清单

改完后必须确认：

### 后端改动
- [ ] 服务能启动：`systemctl status mindlink`
- [ ] API 能调通
- [ ] 日志没有报错

### 前端改动
- [ ] 桌面端页面能打开
- [ ] 移动端页面能打开
- [ ] 核心功能可用
- [ ] 控制台没有报错

### 提交前
- [ ] `git status` 检查改动范围
- [ ] 没有误改不相关文件
- [ ] 没有提交敏感文件

---

## 关键文档

| 文档 | 用途 |
|------|------|
| [docs/ORIGINAL_VISION.md](docs/ORIGINAL_VISION.md) | 产品初心（锚点） |
| [docs/LESSONS.md](docs/LESSONS.md) | 历史教训档案 |
| [docs/API_REFERENCE.md](docs/API_REFERENCE.md) | API 接口文档 |
| [docs/PROMPT_GUIDE.md](docs/PROMPT_GUIDE.md) | 提示词维护指南 |

---

## 服务管理

```bash
systemctl status mindlink    # 查看状态
systemctl restart mindlink   # 重启
journalctl -u mindlink -f    # 查看日志
```

---

**文档版本**: v2.0
**最后更新**: 2026-01-09
