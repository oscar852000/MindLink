<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindLink - Barebones Version</title>
</head>

<body>
    <div data-logic-id="app-container">
        <!-- Sidebar: Mind List -->
        <aside data-logic-id="sidebar">
            <nav data-logic-id="sidebar-header">
                <h1>MindLink</h1>
                <p>把想法变成可演化的记忆单元<br>把单元连接成第二大脑神经网络</p>
                <button id="createMindBtn" data-logic-id="create-mind-button">+ 新建 Mind</button>
                <a href="/admin" data-logic-id="admin-link">提示词管理</a>
            </nav>
            <section id="mindList" data-logic-id="mind-list">
                <!-- Dynamically populated Mind list -->
            </section>
        </aside>

        <!-- Main Content Area -->
        <main data-logic-id="main-content">
            <!-- Empty State -->
            <section id="emptyState" data-logic-id="empty-state">
                <h2>选择或创建一个 Mind</h2>
                <p>开始整理你的想法</p>
            </section>

            <!-- Mind Detail View -->
            <section id="mindDetail" data-logic-id="mind-detail" style="display: none;">
                <header data-logic-id="detail-header">
                    <h2 id="mindTitle">Mind 标题</h2>
                </header>

                <!-- Tab Navigation -->
                <nav data-logic-id="tabs">
                    <button data-tab="feed" data-logic-id="tab-feed">投喂</button>
                    <button data-tab="chat" data-logic-id="tab-chat">对话</button>
                    <button data-tab="timeline" data-logic-id="tab-timeline">时间轴</button>
                    <button data-tab="narrative" data-logic-id="tab-narrative">叙事</button>
                    <button data-tab="structure" data-logic-id="tab-structure">结构</button>
                    <button data-tab="mindmap" data-logic-id="tab-mindmap">导图</button>
                    <button data-tab="output" data-logic-id="tab-output">输出</button>
                </nav>

                <!-- Tab 1: Feed (投喂) -->
                <section id="feedTab" data-logic-id="feed-tab-content">
                    <div data-logic-id="feed-input-area">
                        <textarea id="feedInput" data-logic-id="feed-input" placeholder="输入你的想法..."></textarea>
                        <button id="feedBtn" data-logic-id="feed-submit-button">投喂</button>
                    </div>
                    <div id="feedStatus" data-logic-id="feed-status"></div>
                </section>

                <!-- Tab 2: Chat (对话) -->
                <section id="chatTab" data-logic-id="chat-tab-content" style="display: none;">
                    <header data-logic-id="chat-controls">
                        <select id="chatModel" data-logic-id="chat-model-select">
                            <option value="google_gemini_3_flash">Gemini 3 Flash</option>
                            <option value="google_gemini_3_pro">Gemini 3 Pro</option>
                            <option value="plato_gpt_5_2_chat">GPT-5.2 柏拉图</option>
                        </select>
                        <select id="chatStyle" data-logic-id="chat-style-select">
                            <option value="default">理性分析</option>
                            <option value="socratic">苏格拉底式</option>
                            <option value="creative">创意发散</option>
                        </select>
                        <button id="clearChatBtn" data-logic-id="chat-clear-button">刷新对话</button>
                    </header>
                    <div id="chatMessages" data-logic-id="chat-messages-container">
                        <div data-logic-id="chat-welcome">
                            <p>我已经了解了你关于这个主题的所有想法。</p>
                            <p>有什么想和我讨论的吗？</p>
                        </div>
                    </div>
                    <div data-logic-id="chat-input-area">
                        <textarea id="chatInput" data-logic-id="chat-input" placeholder="输入你想讨论的内容..."
                            rows="2"></textarea>
                        <button id="sendChatBtn" data-logic-id="chat-send-button">发送</button>
                    </div>
                </section>

                <!-- Tab 3: Timeline (时间轴) -->
                <section id="timelineTab" data-logic-id="timeline-tab-content" style="display: none;">
                    <header data-logic-id="timeline-header">
                        <p>去噪后的原始记录，按时间分组显示</p>
                    </header>
                    <div id="timelineContent" data-logic-id="timeline-content">
                        <p>还没有内容，先投喂一些想法吧</p>
                    </div>
                </section>

                <!-- Tab 4: Narrative (叙事) -->
                <section id="narrativeTab" data-logic-id="narrative-tab-content" style="display: none;">
                    <header data-logic-id="narrative-header">
                        <p>整合所有记录，生成连贯的思想叙事</p>
                        <button id="generateNarrativeBtn" data-logic-id="narrative-generate-button">生成叙事</button>
                    </header>
                    <div id="narrativeContent" data-logic-id="narrative-content">
                        <p>点击"生成叙事"按钮，AI 将整合你的所有记录</p>
                    </div>
                </section>

                <!-- Tab 5: Structure (结构) -->
                <section id="structureTab" data-logic-id="structure-tab-content" style="display: none;">
                    <header data-logic-id="structure-header">
                        <p>提炼核心思想，结构化展示</p>
                    </header>
                    <div id="structureContent" data-logic-id="structure-content">
                        <p>还没有内容，先投喂一些想法吧</p>
                    </div>
                </section>

                <!-- Tab 6: Mindmap (导图) -->
                <section id="mindmapTab" data-logic-id="mindmap-tab-content" style="display: none;">
                    <header data-logic-id="mindmap-header">
                        <p>思维导图 - 基于结构视图生成</p>
                        <button id="refreshMindmapBtn" data-logic-id="mindmap-refresh-button">刷新导图</button>
                    </header>
                    <div id="mindmapContainer" data-logic-id="mindmap-container">
                        <p>点击上方"刷新导图"生成思维导图</p>
                    </div>
                </section>

                <!-- Tab 7: Output (输出) -->
                <section id="outputTab" data-logic-id="output-tab-content" style="display: none;">
                    <div data-logic-id="output-input-area">
                        <input type="text" id="outputInstruction" data-logic-id="output-instruction-input"
                            placeholder="输入输出指令，例如：写一段给程序员的说明">
                        <button id="outputBtn" data-logic-id="output-generate-button">生成</button>
                    </div>
                    <div id="outputResult" data-logic-id="output-result"></div>
                </section>
            </section>
        </main>
    </div>

    <!-- Modal: Create Mind -->
    <dialog id="createMindModal" data-logic-id="create-mind-modal">
        <div data-logic-id="modal-content">
            <h3>创建新的 Mind</h3>
            <input type="text" id="newMindTitle" data-logic-id="new-mind-title-input" placeholder="输入标题，例如：AI 想法助手">
            <div data-logic-id="modal-actions">
                <button data-logic-id="modal-cancel-button" onclick="closeModal()">取消</button>
                <button data-logic-id="modal-create-button" onclick="createMind()">创建</button>
            </div>
        </div>
    </dialog>

    <script>
        /**
         * MindLink Barebones Logic Script
         * API调用和事件监听逻辑保留，样式完全移除
         */

        const API_BASE = '/api';

        // ========== Application State ==========
        let currentMindId = null;      // Currently selected Mind ID
        let chatHistory = [];          // Chat conversation history (session-level)

        // ========== DOM Element References ==========
        const mindList = document.getElementById('mindList');
        const emptyState = document.getElementById('emptyState');
        const mindDetail = document.getElementById('mindDetail');
        const mindTitle = document.getElementById('mindTitle');
        const feedInput = document.getElementById('feedInput');
        const feedStatus = document.getElementById('feedStatus');
        const timelineContent = document.getElementById('timelineContent');
        const narrativeContent = document.getElementById('narrativeContent');
        const structureContent = document.getElementById('structureContent');
        const outputInstruction = document.getElementById('outputInstruction');
        const outputResult = document.getElementById('outputResult');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatModel = document.getElementById('chatModel');
        const chatStyle = document.getElementById('chatStyle');

        // ========== Initialization ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadMinds();
            setupEventListeners();
        });

        // ========== Event Listeners Setup ==========
        /**
         * Function: setupEventListeners
         * Purpose: Attach all event listeners to interactive elements
         * Input: None
         * Output: None
         */
        function setupEventListeners() {
            // Create Mind button
            document.getElementById('createMindBtn').addEventListener('click', () => {
                document.getElementById('createMindModal').showModal();
                document.getElementById('newMindTitle').focus();
            });

            // Feed submit button
            document.getElementById('feedBtn').addEventListener('click', submitFeed);

            // Generate narrative button
            document.getElementById('generateNarrativeBtn').addEventListener('click', generateNarrative);

            // Output generate button
            document.getElementById('outputBtn').addEventListener('click', generateOutput);

            // Refresh mindmap button
            document.getElementById('refreshMindmapBtn').addEventListener('click', loadMindmap);

            // Chat controls
            document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
            document.getElementById('clearChatBtn').addEventListener('click', clearChat);

            // Tab switching
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Enter key shortcuts
            document.getElementById('newMindTitle').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createMind();
            });

            feedInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) submitFeed();
            });

            outputInstruction.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') generateOutput();
            });

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }

        // ========== API Functions ==========

        /**
         * Function: loadMinds
         * Purpose: Fetch and display all Mind items from backend
         * API: GET /api/minds
         * Input: None
         * Output: Updates mindList DOM with Mind items
         */
        async function loadMinds() {
            try {
                const response = await fetch(`${API_BASE}/minds`);
                const data = await response.json();

                mindList.innerHTML = '';

                if (data.minds.length === 0) {
                    mindList.innerHTML = '<p>还没有 Mind，创建一个吧</p>';
                    return;
                }

                data.minds.forEach(mind => {
                    const item = document.createElement('div');
                    item.dataset.mindId = mind.id;
                    item.dataset.logicId = 'mind-list-item';
                    if (mind.id === currentMindId) {
                        item.dataset.active = 'true';
                    }
                    item.innerHTML = `
                        <h3>${escapeHtml(mind.title)}</h3>
                        <span>${formatDate(mind.updated_at)}</span>
                    `;
                    item.addEventListener('click', () => selectMind(mind.id));
                    mindList.appendChild(item);
                });
            } catch (error) {
                console.error('加载失败:', error);
            }
        }

        /**
         * Function: selectMind
         * Purpose: Select a Mind and load its details
         * API: GET /api/minds/{mindId}
         * Input: mindId (string)
         * Output: Updates currentMindId, displays Mind detail, loads timeline and structure
         */
        async function selectMind(mindId) {
            currentMindId = mindId;
            chatHistory = []; // Clear chat history when switching Mind

            // Update list active state
            document.querySelectorAll('[data-mind-id]').forEach(item => {
                if (item.dataset.mindId === mindId) {
                    item.dataset.active = 'true';
                } else {
                    delete item.dataset.active;
                }
            });

            // Show detail view
            emptyState.style.display = 'none';
            mindDetail.style.display = 'block';

            // Reset chat area
            chatMessages.innerHTML = `
                <div data-logic-id="chat-welcome">
                    <p>我已经了解了你关于这个主题的所有想法。</p>
                    <p>有什么想和我讨论的吗？</p>
                </div>
            `;

            // Load Mind details
            try {
                const response = await fetch(`${API_BASE}/minds/${mindId}`);
                const mind = await response.json();
                mindTitle.textContent = mind.title;

                // Load timeline and structure
                await Promise.all([
                    loadTimeline(),
                    loadStructure()
                ]);
            } catch (error) {
                console.error('加载失败:', error);
            }
        }

        /**
         * Function: loadTimeline
         * Purpose: Fetch and display timeline view for current Mind
         * API: GET /api/minds/{currentMindId}/timeline-view
         * Input: Uses currentMindId from state
         * Output: Updates timelineContent DOM with timeline items grouped by date
         */
        async function loadTimeline() {
            if (!currentMindId) return;

            try {
                const response = await fetch(`${API_BASE}/minds/${currentMindId}/timeline-view`);
                const data = await response.json();

                if (!data.timeline || data.timeline.length === 0) {
                    timelineContent.innerHTML = '<p>还没有内容，先投喂一些想法吧</p>';
                    return;
                }

                let html = '<div data-logic-id="timeline-list">';
                data.timeline.forEach(day => {
                    html += `<div data-logic-id="timeline-day">
                        <div data-logic-id="timeline-date">${day.date}</div>`;
                    day.items.forEach(item => {
                        html += `<div data-logic-id="timeline-item">
                            <span data-logic-id="timeline-time">${item.time}</span>
                            <div data-logic-id="timeline-text">${escapeHtml(item.content)}</div>
                        </div>`;
                    });
                    html += '</div>';
                });
                html += '</div>';

                timelineContent.innerHTML = html;
            } catch (error) {
                console.error('加载时间轴失败:', error);
                timelineContent.innerHTML = '<p>加载失败</p>';
            }
        }

        /**
         * Function: loadStructure
         * Purpose: Fetch and display structure view (Crystal) for current Mind
         * API: GET /api/minds/{currentMindId}/crystal
         * Input: Uses currentMindId from state
         * Output: Updates structureContent DOM with structured markdown content
         */
        async function loadStructure() {
            if (!currentMindId) return;

            try {
                const response = await fetch(`${API_BASE}/minds/${currentMindId}/crystal`);
                const data = await response.json();

                if (!data.structure_markdown || data.structure_markdown === '还没有内容，先投喂一些想法吧') {
                    structureContent.innerHTML = '<p>还没有内容，先投喂一些想法吧</p>';
                    return;
                }

                structureContent.innerHTML = `<div data-logic-id="structure-text">${markdownToHtml(data.structure_markdown)}</div>`;
            } catch (error) {
                console.error('加载结构失败:', error);
                structureContent.innerHTML = '<p>加载失败</p>';
            }
        }

        /**
         * Function: generateNarrative
         * Purpose: Generate narrative view by combining all timeline records
         * API: POST /api/minds/{currentMindId}/narrative
         * Input: Uses currentMindId from state
         * Output: Updates narrativeContent DOM with generated narrative text
         */
        async function generateNarrative() {
            if (!currentMindId) return;

            const btn = document.getElementById('generateNarrativeBtn');
            btn.disabled = true;
            btn.textContent = '生成中...';
            narrativeContent.innerHTML = '<p>正在整合所有记录，生成叙事...</p>';

            try {
                const response = await fetch(`${API_BASE}/minds/${currentMindId}/narrative`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.narrative) {
                    narrativeContent.innerHTML = `<div data-logic-id="narrative-text">${escapeHtml(data.narrative)}</div>`;
                } else {
                    narrativeContent.innerHTML = '<p>暂无内容</p>';
                }
            } catch (error) {
                console.error('生成叙事失败:', error);
                narrativeContent.innerHTML = '<p>生成失败</p>';
            } finally {
                btn.disabled = false;
                btn.textContent = '生成叙事';
            }
        }

        /**
         * Function: createMind
         * Purpose: Create a new Mind with user-provided title
         * API: POST /api/minds
         * Input: Reads from newMindTitle input field
         * Output: Creates Mind, closes modal, refreshes list, selects new Mind
         */
        async function createMind() {
            const title = document.getElementById('newMindTitle').value.trim();
            if (!title) return;

            try {
                const response = await fetch(`${API_BASE}/minds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });

                if (response.ok) {
                    const mind = await response.json();
                    closeModal();
                    document.getElementById('newMindTitle').value = '';
                    await loadMinds();
                    selectMind(mind.id);
                }
            } catch (error) {
                console.error('创建失败:', error);
            }
        }

        /**
         * Function: closeModal
         * Purpose: Close the create Mind modal dialog
         * Input: None
         * Output: Closes modal
         */
        function closeModal() {
            document.getElementById('createMindModal').close();
        }

        /**
         * Function: submitFeed
         * Purpose: Submit user's feed content to current Mind
         * API: POST /api/minds/{currentMindId}/feed
         * Input: Reads from feedInput textarea
         * Output: Submits content, clears input, triggers backend processing, refreshes timeline & structure
         */
        async function submitFeed() {
            if (!currentMindId) return;

            const content = feedInput.value.trim();
            if (!content) return;

            const btn = document.getElementById('feedBtn');
            btn.disabled = true;
            feedStatus.textContent = '正在处理...';

            try {
                const response = await fetch(`${API_BASE}/minds/${currentMindId}/feed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    feedInput.value = '';
                    feedStatus.textContent = '已记录，正在去噪和更新结构...';

                    // Delay refresh to wait for backend processing
                    setTimeout(async () => {
                        await Promise.all([
                            loadTimeline(),
                            loadStructure()
                        ]);
                        feedStatus.textContent = '处理完成';
                    }, 3000);

                    loadMinds();
                } else {
                    feedStatus.textContent = '提交失败';
                }
            } catch (error) {
                console.error('投喂失败:', error);
                feedStatus.textContent = '提交失败';
            } finally {
                btn.disabled = false;
            }
        }

        /**
         * Function: generateOutput
         * Purpose: Generate custom output based on user instruction
         * API: POST /api/minds/{currentMindId}/output
         * Input: Reads from outputInstruction input field
         * Output: Displays generated content in outputResult
         */
        async function generateOutput() {
            if (!currentMindId) return;

            const instruction = outputInstruction.value.trim();
            if (!instruction) return;

            const btn = document.getElementById('outputBtn');
            btn.disabled = true;
            outputResult.innerHTML = '<p>正在生成...</p>';

            try {
                const response = await fetch(`${API_BASE}/minds/${currentMindId}/output`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instruction })
                });

                if (response.ok) {
                    const data = await response.json();
                    outputResult.innerHTML = `<div data-logic-id="output-text">${escapeHtml(data.content)}</div>`;
                } else {
                    const error = await response.json();
                    outputResult.innerHTML = `<p>${error.detail || '生成失败'}</p>`;
                }
            } catch (error) {
                console.error('生成失败:', error);
                outputResult.innerHTML = '<p>生成失败</p>';
            } finally {
                btn.disabled = false;
            }
        }

        /**
         * Function: loadMindmap
         * Purpose: Generate and display mindmap based on structure view
         * API: GET /api/minds/{currentMindId}/mindmap
         * Input: Uses currentMindId from state
         * Output: Renders mindmap tree structure in mindmapContainer
         */
        async function loadMindmap() {
            if (!currentMindId) return;

            const container = document.getElementById('mindmapContainer');
            container.innerHTML = '<div>正在生成思维导图...</div>';

            try {
                const response = await fetch(`${API_BASE}/minds/${currentMindId}/mindmap`);
                const data = await response.json();

                if (data.mindmap && data.mindmap.branches && data.mindmap.branches.length > 0) {
                    renderMindmap(data.mindmap);
                } else {
                    container.innerHTML = '<p>还没有足够的内容生成导图</p>';
                }
            } catch (error) {
                console.error('加载导图失败:', error);
                container.innerHTML = '<p>加载失败</p>';
            }
        }

        /**
         * Function: renderMindmap
         * Purpose: Render mindmap data structure into HTML
         * Input: mindmap object {center: string, branches: array}
         * Output: Updates mindmapContainer with rendered tree
         */
        function renderMindmap(mindmap) {
            const container = document.getElementById('mindmapContainer');

            let html = '<div data-logic-id="mindmap-tree">';
            html += `<div data-logic-id="tree-center">${escapeHtml(mindmap.center)}</div>`;
            html += '<div data-logic-id="tree-branches">';

            mindmap.branches.forEach(branch => {
                const isPending = branch.type === 'pending';
                html += `<div data-logic-id="tree-branch" data-pending="${isPending}">
                    <div data-logic-id="branch-label">${escapeHtml(branch.label)}${isPending ? ' ❓' : ''}</div>`;

                if (branch.children && branch.children.length > 0) {
                    html += '<ul data-logic-id="branch-children">';
                    branch.children.forEach(child => {
                        html += `<li>${escapeHtml(child)}</li>`;
                    });
                    html += '</ul>';
                }
                html += '</div>';
            });

            html += '</div></div>';
            container.innerHTML = html;
        }

        /**
         * Function: switchTab
         * Purpose: Switch between different tab views
         * Input: tabName (string) - feed|chat|timeline|narrative|structure|mindmap|output
         * Output: Shows selected tab content, hides others
         */
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('[data-tab]').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.dataset.active = 'true';
                } else {
                    delete tab.dataset.active;
                }
            });

            // Update tab content visibility
            const allTabs = ['feed', 'chat', 'timeline', 'narrative', 'structure', 'mindmap', 'output'];
            allTabs.forEach(tab => {
                const element = document.getElementById(`${tab}Tab`);
                if (element) {
                    element.style.display = (tab === tabName) ? 'block' : 'none';
                }
            });
        }

        // ========== Chat Functions ==========

        /**
         * Function: sendChatMessage
         * Purpose: Send user message to chat API and display response
         * API: POST /api/minds/{currentMindId}/chat
         * Input: Reads from chatInput, chatModel, chatStyle, uses chatHistory
         * Output: Adds messages to chatMessages, updates chatHistory
         */
        async function sendChatMessage() {
            if (!currentMindId) return;

            const message = chatInput.value.trim();
            if (!message) return;

            const btn = document.getElementById('sendChatBtn');
            btn.disabled = true;

            // Add user message
            addChatMessage('user', message);
            chatInput.value = '';

            // Add loading state
            const loadingId = addChatMessage('assistant', '思考中...', true);

            try {
                const response = await fetch(`${API_BASE}/minds/${currentMindId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: chatHistory,
                        model: chatModel.value,
                        style: chatStyle.value
                    })
                });

                // Remove loading state
                removeChatMessage(loadingId);

                if (response.ok) {
                    const data = await response.json();
                    // Add AI reply
                    addChatMessage('assistant', data.reply);
                    // Update history
                    chatHistory.push({ role: 'user', content: message });
                    chatHistory.push({ role: 'assistant', content: data.reply });
                } else {
                    const error = await response.json();
                    addChatMessage('assistant', `抱歉，出错了：${error.detail || '请稍后重试'}`);
                }
            } catch (error) {
                console.error('对话失败:', error);
                removeChatMessage(loadingId);
                addChatMessage('assistant', '网络错误，请稍后重试');
            } finally {
                btn.disabled = false;
                chatInput.focus();
            }
        }

        /**
         * Function: addChatMessage
         * Purpose: Add a message to the chat interface
         * Input: role (user|assistant), content (string), isLoading (boolean)
         * Output: Appends message to chatMessages, returns messageId
         */
        function addChatMessage(role, content, isLoading = false) {
            // Hide welcome message
            const welcome = chatMessages.querySelector('[data-logic-id="chat-welcome"]');
            if (welcome) {
                welcome.style.display = 'none';
            }

            const messageId = `msg_${Date.now()}`;
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.dataset.logicId = 'chat-message';
            messageDiv.dataset.role = role;
            if (isLoading) messageDiv.dataset.loading = 'true';

            const roleText = role === 'user' ? '你' : 'AI';
            messageDiv.innerHTML = `
                <div data-logic-id="chat-role">${roleText}</div>
                <div data-logic-id="chat-content">${escapeHtml(content)}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return messageId;
        }

        /**
         * Function: removeChatMessage
         * Purpose: Remove a message from chat interface by ID
         * Input: messageId (string)
         * Output: Removes message element
         */
        function removeChatMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        /**
         * Function: clearChat
         * Purpose: Clear all chat history and reset conversation
         * Input: None
         * Output: Clears chatHistory state and chatMessages DOM
         */
        function clearChat() {
            if (!confirm('确定要刷新对话吗？当前对话记录将被清空。')) {
                return;
            }

            chatHistory = [];
            chatMessages.innerHTML = `
                <div data-logic-id="chat-welcome">
                    <p>我已经了解了你关于这个主题的所有想法。</p>
                    <p>有什么想和我讨论的吗？</p>
                </div>
            `;
        }

        // ========== Utility Functions ==========

        /**
         * Function: escapeHtml
         * Purpose: Escape HTML special characters to prevent XSS
         * Input: text (string)
         * Output: escaped HTML string
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Function: formatDate
         * Purpose: Format ISO date string to readable Chinese format
         * Input: dateStr (ISO string)
         * Output: formatted date string (e.g., "12月 28日")
         */
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        }

        /**
         * Function: markdownToHtml
         * Purpose: Convert simple markdown to HTML (headers, lists)
         * Input: markdown (string)
         * Output: HTML string
         */
        function markdownToHtml(markdown) {
            if (!markdown) return '';
            return markdown
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/<\/ul>\s*<ul>/g, '')
                .replace(/\n/g, '<br>');
        }
    </script>
</body>

</html>