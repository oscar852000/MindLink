<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindLink - 提示词管理 - Barebones</title>
</head>

<body>
    <div data-logic-id="admin-app-container">
        <header data-logic-id="admin-header">
            <h1>MindLink 提示词管理</h1>
            <a href="/" data-logic-id="back-to-home-link">← 返回主页</a>
        </header>

        <main data-logic-id="admin-main">
            <!-- Prompt List -->
            <section id="promptList" data-logic-id="prompt-list">
                <!-- Dynamically populated prompt list -->
            </section>

            <!-- Prompt Editor -->
            <section id="promptEditor" data-logic-id="prompt-editor" style="display: none;">
                <header data-logic-id="editor-header">
                    <h2 id="editorTitle">编辑提示词</h2>
                    <div data-logic-id="editor-actions">
                        <button data-logic-id="reset-prompt-button" onclick="resetPrompt()">重置为默认</button>
                        <button data-logic-id="save-prompt-button" onclick="savePrompt()">保存</button>
                    </div>
                </header>
                <div data-logic-id="editor-info">
                    <p id="editorDescription"></p>
                    <p>提示：修改后点击保存，系统会在下次调用时使用新的提示词</p>
                </div>
                <textarea id="promptContent" data-logic-id="prompt-content-textarea"
                    placeholder="输入提示词内容..."></textarea>
            </section>
        </main>
    </div>

    <script>
        /**
         * MindLink Admin Panel - Barebones Logic Script
         * Prompt management functionality
         */

        const API_BASE = '/api';

        // ========== Application State ==========
        let currentPromptKey = null;  // Currently selected prompt key
        let prompts = [];             // All prompts loaded from backend

        // ========== DOM Element References ==========
        const promptList = document.getElementById('promptList');
        const promptEditor = document.getElementById('promptEditor');
        const editorTitle = document.getElementById('editorTitle');
        const editorDescription = document.getElementById('editorDescription');
        const promptContent = document.getElementById('promptContent');

        // ========== Initialization ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadPrompts();
        });

        // ========== API Functions ==========

        /**
         * Function: loadPrompts
         * Purpose: Fetch all prompts from backend and display in list
         * API: GET /api/prompts
         * Input: None
         * Output: Updates promptList DOM with all available prompts
         */
        async function loadPrompts() {
            try {
                const response = await fetch(`${API_BASE}/prompts`);
                const data = await response.json();

                prompts = data.prompts || [];
                promptList.innerHTML = '';

                if (prompts.length === 0) {
                    promptList.innerHTML = '<p>没有可用的提示词</p>';
                    return;
                }

                prompts.forEach(prompt => {
                    const item = document.createElement('div');
                    item.dataset.logicId = 'prompt-list-item';
                    item.dataset.promptKey = prompt.key;
                    if (prompt.key === currentPromptKey) {
                        item.dataset.active = 'true';
                    }

                    item.innerHTML = `
                        <h3>${escapeHtml(prompt.name)}</h3>
                        <p>${escapeHtml(prompt.description)}</p>
                        <span>${prompt.is_custom ? '已自定义' : '使用默认'}</span>
                    `;

                    item.addEventListener('click', () => selectPrompt(prompt.key));
                    promptList.appendChild(item);
                });
            } catch (error) {
                console.error('加载提示词失败:', error);
                promptList.innerHTML = '<p>加载失败</p>';
            }
        }

        /**
         * Function: selectPrompt
         * Purpose: Select a prompt and load it into the editor
         * API: GET /api/prompts/{promptKey}
         * Input: promptKey (string)
         * Output: Updates currentPromptKey, displays editor with prompt content
         */
        async function selectPrompt(promptKey) {
            currentPromptKey = promptKey;

            // Update list active state
            document.querySelectorAll('[data-prompt-key]').forEach(item => {
                if (item.dataset.promptKey === promptKey) {
                    item.dataset.active = 'true';
                } else {
                    delete item.dataset.active;
                }
            });

            // Show editor
            promptEditor.style.display = 'block';

            // Load prompt details
            try {
                const response = await fetch(`${API_BASE}/prompts/${promptKey}`);
                const prompt = await response.json();

                editorTitle.textContent = `编辑: ${prompt.name}`;
                editorDescription.textContent = prompt.description;
                promptContent.value = prompt.content;
            } catch (error) {
                console.error('加载提示词详情失败:', error);
                alert('加载失败');
            }
        }

        /**
         * Function: savePrompt
         * Purpose: Save modified prompt content to backend
         * API: PUT /api/prompts/{currentPromptKey}
         * Input: Reads from promptContent textarea
         * Output: Saves prompt, refreshes list
         */
        async function savePrompt() {
            if (!currentPromptKey) return;

            const content = promptContent.value.trim();
            if (!content) {
                alert('提示词内容不能为空');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prompts/${currentPromptKey}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    alert('保存成功');
                    await loadPrompts();
                } else {
                    const error = await response.json();
                    alert(`保存失败: ${error.detail || '未知错误'}`);
                }
            } catch (error) {
                console.error('保存失败:', error);
                alert('保存失败');
            }
        }

        /**
         * Function: resetPrompt
         * Purpose: Reset prompt to default content
         * API: DELETE /api/prompts/{currentPromptKey}
         * Input: Uses currentPromptKey
         * Output: Resets prompt to default, refreshes list and editor
         */
        async function resetPrompt() {
            if (!currentPromptKey) return;

            if (!confirm('确定要重置为默认提示词吗？')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prompts/${currentPromptKey}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('重置成功');
                    await loadPrompts();
                    await selectPrompt(currentPromptKey);
                } else {
                    const error = await response.json();
                    alert(`重置失败: ${error.detail || '未知错误'}`);
                }
            } catch (error) {
                console.error('重置失败:', error);
                alert('重置失败');
            }
        }

        // ========== Utility Functions ==========

        /**
         * Function: escapeHtml
         * Purpose: Escape HTML special characters to prevent XSS
         * Input: text (string)
         * Output: escaped HTML string
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>