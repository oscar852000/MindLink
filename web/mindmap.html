<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>思维导图 - MindLink</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            overflow: hidden;
            height: 100vh;
            width: 100%;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        /* Header 样式 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            background: #00D4DD;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        .header-subtitle {
            color: #94a3b8;
            font-weight: 400;
            margin-left: 8px;
            font-size: 14px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8fafc;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .header-controls button {
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-controls button:hover {
            background: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .header-controls button svg {
            width: 18px;
            height: 18px;
        }

        .zoom-level {
            font-size: 12px;
            font-weight: 600;
            min-width: 48px;
            text-align: center;
            color: #64748b;
        }

        .divider {
            width: 1px;
            height: 16px;
            background: #cbd5e1;
            margin: 0 4px;
        }

        /* Main content */
        .main-content {
            flex: 1;
            position: relative;
            cursor: grab;
        }

        .main-content.grabbing {
            cursor: grabbing;
        }

        .main-content svg {
            width: 100%;
            height: 100%;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        /* Loading 状态 */
        .loading-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(2px);
            z-index: 20;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid #e2e8f0;
            border-top-color: #00D4DD;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 底部提示 */
        .bottom-tips {
            position: absolute;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(30, 41, 59, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            font-size: 12px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.8;
        }

        .tip-item svg {
            width: 14px;
            height: 14px;
            color: #00D4DD;
        }

        .tip-divider {
            width: 1px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .header-controls {
                display: none;
            }

            .header-subtitle {
                display: none;
            }

            .bottom-tips {
                font-size: 11px;
                padding: 8px 16px;
            }
        }

        /* D3.js 节点样式由 JS 直接控制 */
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                </div>
                <div>
                    <span class="header-title">MindLink</span>
                    <span class="header-subtitle">思维导图</span>
                </div>
            </div>

            <div class="header-controls">
                <button onclick="handleZoom('out')" title="缩小">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button onclick="handleZoom('in')" title="放大">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                        <line x1="11" y1="8" x2="11" y2="14"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
                <div class="divider"></div>
                <button onclick="handleZoom('reset')" title="重置">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path
                            d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                        </path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
            </div>
            <svg id="mindmapSvg"></svg>
        </main>

        <!-- Bottom Tips -->
        <div class="bottom-tips">
            <div class="tip-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path>
                    <path d="m13 13 6 6"></path>
                </svg>
                <span>点击节点探索</span>
            </div>
            <div class="tip-divider"></div>
            <div class="tip-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <polyline points="5 9 2 12 5 15"></polyline>
                    <polyline points="9 5 12 2 15 5"></polyline>
                    <polyline points="15 19 12 22 9 19"></polyline>
                    <polyline points="19 9 22 12 19 15"></polyline>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <line x1="12" y1="2" x2="12" y2="22"></line>
                </svg>
                <span>自由缩放平移</span>
            </div>
        </div>
    </div>

    <script>
        // 示例数据（后续可通过 API 获取）
        const INITIAL_DATA = {
            name: "核心商业战略 2026",
            children: [
                {
                    name: "市场洞察",
                    children: [
                        { name: "中国电商趋势", children: [{ name: "下沉市场渗透" }, { name: "直播电商 2.0" }] },
                        { name: "竞争对手分析", children: [{ name: "溢价能力研究" }, { name: "供应链护城河" }] }
                    ]
                },
                {
                    name: "效率提升",
                    children: [
                        { name: "AI 流程自动化", children: [{ name: "减少内部内耗" }, { name: "自动化合规审查" }] },
                        { name: "组织架构优化", children: [{ name: "扁平化管理" }, { name: "规范化文档系统" }] }
                    ]
                },
                {
                    name: "创新与增长",
                    children: [
                        { name: "利己主义研究", children: [{ name: "用户动机建模" }] },
                        { name: "哲学思辨工具", children: [{ name: "批判性反馈系统" }] }
                    ]
                },
                {
                    name: "技术底座",
                    children: [
                        { name: "大模型私有化" },
                        { name: "边缘计算节点" }
                    ]
                }
            ]
        };

        // 全局变量
        let data = null;
        let zoomBehavior = null;
        let currentZoom = 100;

        // DOM 元素引用
        const svgElement = document.getElementById('mindmapSvg');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContent = document.getElementById('mainContent');
        const zoomLevelEl = document.getElementById('zoomLevel');

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 从URL获取mind_id（如果有）
            const urlParams = new URLSearchParams(window.location.search);
            const mindId = urlParams.get('mind_id') || localStorage.getItem('currentMindId');
            console.log('[MindMap] mind_id:', mindId, 'URL:', window.location.href);

            if (!mindId) {
                // 没有mind_id，显示提示
                console.log('[MindMap] No mind_id, showing placeholder');
                data = {
                    name: "MindLink思维导图",
                    children: [{ "name": "请选择一个Mind" }]
                };
                loadingOverlay.style.display = 'none';
                renderMindMap();
                return;
            }

            // 从API获取真实数据（禁用缓存）
            fetch(`/api/minds/${mindId}/mindmap`, {
                cache: 'no-store',
                credentials: 'include'
            })
                .then(response => {
                    console.log('[MindMap] API response status:', response.status);
                    if (!response.ok) throw new Error('获取失败');
                    return response.json();
                })
                .then(mindmapData => {
                    console.log('[MindMap] API data:', JSON.stringify(mindmapData).substring(0, 200));
                    data = mindmapData;
                    loadingOverlay.style.display = 'none';
                    renderMindMap();
                })
                .catch(error => {
                    console.error('获取思维导图失败:', error);
                    // 失败时显示错误提示
                    data = {
                        name: "加载失败",
                        children: [{ "name": "请刷新重试" }]
                    };
                    loadingOverlay.style.display = 'none';
                    renderMindMap();
                });
            // 添加拖拽样式切换
            svgElement.addEventListener('mousedown', () => {
                mainContent.classList.add('grabbing');
            });

            document.addEventListener('mouseup', () => {
                mainContent.classList.remove('grabbing');
            });

            // 响应窗口大小变化
            window.addEventListener('resize', () => {
                if (data) renderMindMap();
            });
        });

        // 渲染思维导图
        function renderMindMap() {
            if (!data || !window.d3) return;

            const d3 = window.d3;
            const width = mainContent.clientWidth;
            const height = mainContent.clientHeight;

            // 清空现有内容
            d3.select(svgElement).selectAll("*").remove();

            // 创建 SVG
            const svg = d3.select(svgElement)
                .attr("viewBox", [0, 0, width, height])
                .attr("width", "100%")
                .attr("height", "100%");

            const gMain = svg.append("g");

            // 分层：先创建连线层，再创建节点层（确保线在节点下方）
            const linkLayer = gMain.append("g").attr("class", "links-layer");
            const nodeLayer = gMain.append("g").attr("class", "nodes-layer");

            // 缩放行为
            const zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => {
                    gMain.attr("transform", event.transform);
                    currentZoom = Math.round(event.transform.k * 100);
                    zoomLevelEl.textContent = currentZoom + '%';
                });

            svg.call(zoom);
            zoomBehavior = zoom;

            // 创建树布局
            const tree = d3.tree().nodeSize([45, 220]);
            const root = d3.hierarchy(data);

            // 默认折叠深度 >= 2 的节点
            root.descendants().forEach((d, i) => {
                d._children = d.children;
                if (d.depth >= 2) d.children = null;
            });

            // 更新函数
            const update = (source) => {
                const nodes = root.descendants();
                const links = root.links();

                tree(root);

                // 1. 渲染连接线
                const gLinks = linkLayer.selectAll(".link")
                    .data(links, d => d.target.id);

                const linkEnter = gLinks.enter().append("path")
                    .attr("class", "link")
                    .attr("d", d3.linkHorizontal()
                        .x(d => source.y0 || source.y)
                        .y(d => source.x0 || source.x))
                    .attr("fill", "none")
                    .attr("stroke", "#E2E8F0")
                    .attr("stroke-width", 2)
                    .style("opacity", 0);

                gLinks.merge(linkEnter).transition().duration(400)
                    .attr("d", d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x))
                    .style("opacity", 1);

                gLinks.exit().transition().duration(400)
                    .attr("d", d3.linkHorizontal()
                        .x(d => source.y)
                        .y(d => source.x))
                    .style("opacity", 0)
                    .remove();

                // 2. 渲染节点
                const gNodes = nodeLayer.selectAll(".node")
                    .data(nodes, d => d.id || (d.id = Math.random()));

                const nodeEnter = gNodes.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", d => `translate(${source.y0 || source.y},${source.x0 || source.x})`)
                    .style("opacity", 0)
                    .on("click", (event, d) => {
                        if (d.children) {
                            d._children = d.children;
                            d.children = null;
                        } else {
                            d.children = d._children;
                            d._children = null;
                        }
                        update(d);
                    })
                    .style("cursor", d => (d.children || d._children) ? "pointer" : "default");

                // 节点背景框
                nodeEnter.append("rect")
                    .attr("rx", 8)
                    .attr("ry", 8)
                    .attr("y", -16)
                    .attr("x", 0)
                    .attr("width", d => {
                        const textLen = d.data.name.length;
                        return textLen * 14 + 32;
                    })
                    .attr("height", 32)
                    .attr("fill", d => d.depth === 0 ? "#00D4DD" : (d.depth === 1 ? "#F8FAFC" : "#FFFFFF"))
                    .attr("stroke", d => d.depth === 0 ? "#00D4E0" : "#E2E8F0")
                    .attr("stroke-width", 1.5)
                    .style("filter", d => d.depth === 0 ? "none" : "drop-shadow(0 2px 4px rgba(0,0,0,0.04))");

                // 节点文字
                nodeEnter.append("text")
                    .attr("dy", "0.35em")
                    .attr("x", 16)
                    .attr("fill", d => d.depth === 0 ? "#FFFFFF" : "#1E293B")
                    .style("font-size", d => d.depth === 0 ? "14px" : "13px")
                    .style("font-weight", d => d.depth === 0 ? "700" : "500")
                    .style("pointer-events", "none")
                    .text(d => d.data.name);

                // 状态指示点（展开/收起）
                nodeEnter.filter(d => d._children || d.children)
                    .append("circle")
                    .attr("r", 4)
                    .attr("cx", d => d.data.name.length * 14 + 32)
                    .attr("cy", 0)
                    .attr("fill", d => d.children ? "#94A3B8" : "#00D4DD")
                    .attr("stroke", "#FFFFFF")
                    .attr("stroke-width", 2);

                // 更新状态指示点颜色
                nodeEnter.filter(d => d._children || d.children)
                    .select('circle')
                    .attr('fill', d => d.children ? '#94A3B8' : '#00D4DD');

                const nodeUpdate = gNodes.merge(nodeEnter).transition().duration(400)
                    .attr("transform", d => `translate(${d.y},${d.x})`)
                    .style("opacity", 1);

                gNodes.exit().transition().duration(400)
                    .attr("transform", d => `translate(${source.y},${source.x})`)
                    .style("opacity", 0)
                    .remove();

                nodes.forEach(d => {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            };

            root.x0 = height / 2;
            root.y0 = 0;
            update(root);

            // 初始缩放和位置
            const initialScale = width < 768 ? 0.6 : 0.8;
            svg.call(zoom.transform, d3.zoomIdentity.translate(width * 0.1, height / 2).scale(initialScale));
        }

        // 缩放控制函数
        function handleZoom(type) {
            if (!window.d3 || !svgElement || !zoomBehavior) return;

            const d3 = window.d3;
            const svg = d3.select(svgElement);
            const width = mainContent.clientWidth;
            const height = mainContent.clientHeight;

            if (type === 'in') {
                svg.transition().duration(300).call(zoomBehavior.scaleBy, 1.3);
            } else if (type === 'out') {
                svg.transition().duration(300).call(zoomBehavior.scaleBy, 0.7);
            } else if (type === 'reset') {
                svg.transition().duration(300).call(
                    zoomBehavior.transform,
                    d3.zoomIdentity.translate(width * 0.1, height / 2).scale(0.8)
                );
            }
        }
    </script>
</body>

</html>